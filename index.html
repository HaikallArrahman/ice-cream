<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>
      Warung Sembako - Admin dengan Firestore, Auth & Barcode Scanner
    </title>

    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Bootstrap 5.3 latest -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
      crossorigin="anonymous"
    />
    <!-- SweetAlert2 -->
    <link
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
      rel="stylesheet"
    />

    <style>
      /* Base light theme */
      body {
        background: linear-gradient(135deg, #c3e7f7 0%, #fff 100%);
        min-height: 100vh;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        color: #33475b;
        padding: 30px 15px 50px;
        transition: background-color 0.3s ease, color 0.3s ease;
      }
      .container {
        max-width: 900px;
        background: #fefefe;
        padding: 35px 40px;
        border-radius: 16px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.1),
          0 8px 20px rgba(0, 0, 0, 0.07);
        position: relative;
        z-index: 1;
      }
      nav button.nav-link.active {
        background: linear-gradient(135deg, #1962d0 0%, #0d3d81 100%);
        color: white !important;
      }
      #btnLogout {
        position: fixed;
        top: 15px;
        right: 25px;
        z-index: 1051;
      }
      .table thead {
        background: #2980b9;
        color: #fff;
      }
      .table tbody tr {
        background: #f4faff;
        border-radius: 12px;
        box-shadow: 0 3px 10px rgba(25, 98, 208, 0.15);
      }
      .table {
        border-collapse: separate !important;
        border-spacing: 0 9px !important;
      }
      .table tbody tr td:first-child {
        border-top-left-radius: 12px;
        border-bottom-left-radius: 12px;
      }
      .table tbody tr td:last-child {
        border-top-right-radius: 12px;
        border-bottom-right-radius: 12px;
      }
      #reader {
        width: 320px;
        margin: 15px auto 0;
        border-radius: 12px;
        box-shadow: 0 0 12px rgba(25, 98, 208, 0.5);
      }
      #scanResult {
        text-align: center;
        margin-top: 12px;
        font-weight: 700;
        color: #1962d0;
        font-size: 1.25rem;
      }
      /* Overlay Blur */
      #overlayBlur {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        backdrop-filter: blur(6px);
        background-color: rgba(255, 255, 255, 0.3);
        pointer-events: none;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1040;
      }
      #overlayBlur.active {
        pointer-events: auto;
        opacity: 1;
      }
      /* Additional styling */
      .btn-scan {
        font-weight: 600;
        font-size: 1.1rem;
        padding: 0.5rem 1.5rem;
        border-radius: 30px;
        transition: background-color 0.3s ease, box-shadow 0.3s ease;
      }
      .btn-scan:hover {
        background-color: #0d3d81;
        color: #fff;
        box-shadow: 0 8px 24px rgba(25, 98, 208, 0.6);
      }
      /* Admin header */
      #judulAdmin {
        font-weight: 700;
        color: #1053af;
      }
      /* Customize modal */
      .modal-content {
        border-radius: 12px;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.15);
      }
      .modal-title {
        color: #0d3d81;
        font-weight: 700;
      }
      /* Buttons spacing in modal */
      .modal-footer.d-flex.gap-2 > button {
        font-size: 1rem;
        padding: 0.5rem 0;
        border-radius: 8px;
        transition: background-color 0.3s ease;
      }
      /* Responsive adjustments */
      @media (max-width: 480px) {
        #reader {
          width: 100%;
        }
        .btn-scan {
          padding: 0.5rem 1rem;
          font-size: 1rem;
          width: 100%;
        }
        #scanResult {
          font-size: 1rem;
        }
      }

      /* Dark theme */
      body.dark-theme {
        background: #121212;
        color: #ddd;
      }
      body.dark-theme .container {
        background: #1e1e1e;
        box-shadow: 0 14px 40px rgba(0, 0, 0, 0.7);
        color: #ddd;
      }
      body.dark-theme nav button.nav-link.active {
        background: linear-gradient(135deg, #4a9cf7 0%, #2768d1 100%);
        color: #eef5ff !important;
      }
      body.dark-theme .table thead {
        background: #2768d1;
      }
      body.dark-theme .table tbody tr {
        background: #2a2a2a;
        box-shadow: 0 3px 10px rgba(74, 156, 247, 0.4);
      }
      body.dark-theme #reader {
        box-shadow: 0 0 12px #4a9cf7;
      }
      body.dark-theme #btnLogout {
        background-color: #d9534f;
        color: #fff;
        border: none;
      }
      body.dark-theme .btn-scan:hover {
        background-color: #4a9cf7;
      }
      body.dark-theme .modal-content {
        background-color: #2a2a2a;
        color: #ddd;
      }
      body.dark-theme .modal-title {
        color: #4a9cf7;
      }
      body.dark-theme .form-control {
        background-color: #3c3c3c;
        color: #ddd;
        border-color: #555;
      }
      body.dark-theme .form-control:focus {
        background-color: #444;
        color: #fff;
        border-color: #4a9cf7;
        box-shadow: 0 0 4px #4a9cf7;
      }
      body.dark-theme .btn-primary {
        background-color: #4a9cf7;
        border: none;
      }
      body.dark-theme .btn-danger {
        background-color: #d9534f;
        border: none;
      }
      body.dark-theme .text-muted {
        color: #aaa !important;
      }
      /* Settings Button inside admin */
      #btnOpenSettings {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1052;
      }
      /* Settings Panel */
      #adminSettings {
        max-width: 500px;
      }
      #adminSettings label,
      #adminSettings h3,
      #adminSettings button {
        user-select: none;
      }

      @keyframes placeholder-shimmer {
        0% {
          background-position: -200% 0;
        }
        100% {
          background-position: 200% 0;
        }
      }

      input::placeholder {
        color: transparent;
        background: linear-gradient(
          90deg,
          #cccccc 25%,
          #e0e0e0 50%,
          #cccccc 75%
        );
        background-size: 200% 100%;
        background-repeat: no-repeat;
        animation: placeholder-shimmer 1.5s linear infinite;
        -webkit-background-clip: text;
        background-clip: text;
      }

      #settingsPanel {
        display: none;
        /* atau jika menggunakan class .show */
      }

      #settingsPanel.show {
        display: block;
      }
    </style>
  </head>
  <body>
    <button
      id="btnLogout"
      class="btn btn-danger d-none shadow-sm"
      aria-label="Logout"
    >
      Logout
    </button>

    <!-- Theme toggle outside admin -->
    <button
      id="btnToggleTheme"
      class="btn btn-outline-secondary shadow-sm"
      style="position: fixed; bottom: 20px; left: 20px; z-index: 1052"
      aria-label="Toggle Dark/Light Theme"
      title="Toggle Dark/Light Theme"
    >
      üåì
    </button>

    <!-- Settings button (inside admin only) -->
    <button
      id="btnOpenSettings"
      class="btn btn-outline-primary d-none shadow-sm"
      aria-label="Open Settings"
      title="Pengaturan"
    >
      ‚öôÔ∏è Pengaturan
    </button>

    <div id="overlayBlur"></div>

    <div class="container py-5" role="main">
      <ul
        class="nav nav-tabs mb-4"
        id="tabNav"
        role="tablist"
        aria-label="Navigation tabs"
      >
        <li class="nav-item" role="presentation">
          <button
            class="nav-link active"
            id="daftar-tab"
            data-bs-toggle="tab"
            data-bs-target="#daftar"
            type="button"
            role="tab"
            aria-controls="daftar"
            aria-selected="true"
          >
            <h6>
              <i class="fa-solid fa-bag-shopping" style="color: #000000"></i>
              Daftar Produk
            </h6>
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button
            class="nav-link"
            id="admin-tab"
            data-bs-toggle="tab"
            data-bs-target="#admin"
            type="button"
            role="tab"
            aria-controls="admin"
            aria-selected="false"
          >
            <h6>
              <i class="fa-solid fa-lock fa-4xs" style="color: #000000"> </i>
              Admin
            </h6>
          </button>
        </li>
      </ul>

      <div class="tab-content" id="tabContent">
        <div
          class="tab-pane fade show active"
          id="daftar"
          role="tabpanel"
          aria-labelledby="daftar-tab"
          tabindex="0"
        >
          <h1
            id="judulDaftarProduk"
            class="h3 text-center mb-3 text-primary"
            tabindex="0"
          >
            Daftar Harga Warung Sembako
          </h1>
          <input
            type="text"
            id="filter"
            placeholder="Cari produk . . ."
            class="form-control form-control lg shadow-none"
          />
          <div class="table-responsive shadow-sm rounded">
            <table
              class="table table-striped table-bordered align-middle mb-0"
              aria-label="Daftar Harga Produk"
            >
              <thead>
                <tr>
                  <th data-i18n="product_name">Nama Produk</th>
                  <th data-i18n="price_rp">Harga (Rp)</th>
                </tr>
              </thead>
              <tbody id="tabelDaftarProduk">
                <tr>
                  <td
                    colspan="2"
                    class="text-center fst-italic"
                    data-i18n="loading_data"
                  >
                    Sedang memuat data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <div class="text-center mt-4 mb-4">
            <button
              id="btnScanBarcode"
              class="btn btn-outline-primary btn-scan"
              data-i18n="scan_barcode"
              aria-label="Scan Barcode"
            >
              Scan Kode Batang
            </button>
            <button
              id="btnStopScan"
              class="btn btn-outline-danger btn-scan d-none"
              data-i18n="stop_scan"
              aria-label="Stop Scan"
            >
              Stop Scan
            </button>
          </div>
          <div
            id="reader"
            style="display: none"
            aria-live="polite"
            aria-atomic="true"
          ></div>
          <div id="scanResult" aria-live="polite" aria-atomic="true"></div>
        </div>

        <div
          class="tab-pane fade"
          id="admin"
          role="tabpanel"
          aria-labelledby="admin-tab"
          tabindex="0"
        >
          <h1 id="judulAdmin" class="h3 text-center mb-3" tabindex="0">
            Hello {User}
          </h1>
          <button
            id="btnTambah"
            class="btn btn-primary mb-3 shadow-sm"
            disabled
            data-i18n="add_new_product"
            aria-label="Tambah Produk Baru"
          >
            Tambah Produk Baru
          </button>
          <div class="mb-3">
            <input
              type="text"
              class="form-control"
              id="filterAdmin"
              placeholder="Cari produk . . ."
              aria-label="Cari produk"
            />
          </div>
          <form
            id="formProduk"
            class="row g-3 d-none shadow-sm rounded p-4"
            novalidate
            aria-label="Form tambah/edit produk"
          >
            <div class="col-md-6">
              <label for="inputNama" class="form-label" data-i18n="product_name"
                >Nama Produk</label
              >
              <input
                type="text"
                class="form-control"
                id="inputNama"
                required
                autocomplete="off"
                placeholder="Masukkan nama produk"
                aria-required="true"
              />
              <div
                class="invalid-feedback"
                data-i18n="please_fill_product_name"
              >
                Mohon isi nama produk.
              </div>
            </div>
            <div class="col-md-6">
              <label for="inputHarga" class="form-label" data-i18n="price_rp"
                >Harga (Rp)</label
              >
              <input
                type="number"
                class="form-control"
                id="inputHarga"
                min="0"
                step="100"
                required
                autocomplete="off"
                placeholder="Masukkan harga produk"
                aria-required="true"
              />
              <div class="invalid-feedback" data-i18n="please_fill_valid_price">
                Mohon isi harga produk yang valid.
              </div>
            </div>
            <div class="col-md-12 mt-2 d-flex gap-2 align-items-center">
              <label for="inputBarcode" class="form-label" data-i18n="barcode">
                Kode Batang (Barcode)
              </label>
              <input
                type="text"
                class="form-control"
                id="inputBarcode"
                autocomplete="off"
                placeholder="Masukkan kode batang atau scan"
              />
              
            </div>
            <div class="col-12 d-flex gap-2 justify-content-end">
              <button
                type="submit"
                class="btn btn-primary btn-lg px-4"
                data-i18n="save"
                aria-label="Simpan Produk"
              >
                Simpan
              </button>
              <button
                type="button"
                class="btn btn-danger btn-lg px-4"
                id="btnBatal"
                data-i18n="cancel"
                aria-label="Batal Simpan Produk"
              >
                Batal
              </button>
            </div>
          </form>

          <!-- Settings Panel inside Admin -->
          <div
            id="adminSettings"
            class="shadow-sm rounded p-4 border mt-4 d-none"
            aria-label="Pengaturan"
            tabindex="0"
          >
            <h3>Pengaturan</h3>
            <form id="formSettings" novalidate>
              <div class="mb-3">
                <label for="settingTitle" class="form-label"
                  >Judul Halaman Daftar Produk</label
                >
                <input
                  type="text"
                  id="settingTitle"
                  class="form-control"
                  placeholder="Tulis judul (contoh: Daftar Harga Warung Sembako)"
                  maxlength="50"
                />
              </div>
              <div class="mb-3">
                <label for="settingLanguage" class="form-label">Bahasa</label>
                <select
                  id="settingLanguage"
                  class="form-select"
                  aria-label="Pilih Bahasa"
                >
                  <option value="id">Bahasa Indonesia</option>
                  <option value="en">English</option>
                </select>
              </div>
              <button
                type="submit"
                class="btn btn-success"
                aria-label="Simpan Pengaturan"
              >
                Simpan Pengaturan
              </button>
            </form>
          </div>

          <div class="table-responsive shadow-sm rounded mt-4">
            <table
              class="table table-striped table-bordered align-middle mb-0"
              aria-label="Daftar Produk Admin"
            >
              <thead>
                <tr>
                  <th data-i18n="product_name">Nama Produk</th>
                  <th data-i18n="price_rp">Harga (Rp)</th>
                  <th data-i18n="actions">Aksi</th>
                </tr>
              </thead>
              <tbody id="tabelAdminProduk">
                <tr>
                  <td
                    colspan="3"
                    class="text-center fst-italic"
                    data-i18n="loading_data"
                  >
                    Sedang memuat data...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Login -->
    <div
      class="modal fade"
      id="modalLogin"
      data-bs-backdrop="static"
      data-bs-keyboard="false"
      tabindex="-1"
      aria-labelledby="modalLoginLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content needs-validation" id="formLogin" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="modalLoginLabel">Login Admin</h5>
          </div>
          <div class="modal-body">
            <div class="mb-3">
              <label for="loginEmail" class="form-label" data-i18n="email"
                >Email</label
              >
              <input
                type="email"
                class="form-control"
                id="loginEmail"
                required
                autocomplete="username"
                placeholder="Masukkan email"
                aria-required="true"
              />
              <div class="invalid-feedback" data-i18n="please_enter_email">
                Mohon masukkan email yang valid.
              </div>
            </div>
            <div class="mb-3">
              <label for="loginPassword" class="form-label" data-i18n="password"
                >Password</label
              >
              <input
                type="password"
                class="form-control"
                id="loginPassword"
                required
                autocomplete="current-password"
                placeholder="Masukkan password"
                aria-required="true"
              />
              <div class="invalid-feedback" data-i18n="please_enter_password">
                Mohon masukkan password.
              </div>
            </div>
            <div class="text-danger" id="loginError" aria-live="polite"></div>
          </div>
          <div class="modal-footer d-flex gap-2">
            <button
              type="submit"
              class="btn btn-primary w-100 btn-lg"
              data-i18n="login"
              aria-label="Login"
            >
              Login
            </button>
            <button
              type="button"
              class="btn btn-danger w-100 btn-lg"
              id="btnCancelLogin"
              data-i18n="cancel"
              aria-label="Batal Login"
            >
              Batal
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <!-- Bootstrap Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Html5 QR Code (barcode scanner) -->
    <script
      src="https://unpkg.com/html5-qrcode"
      type="text/javascript"
    ></script>

    <script>
      -(() => {
        const firebaseConfig = {
          apiKey: "AIzaSyANU8fTIPC3b0bbelAvALVwtZVnStd3UF4",
          authDomain: "warung-4d2ae.firebaseapp.com",
          projectId: "warung-4d2ae",
          storageBucket: "warung-4d2ae.firebasestorage.app",
          messagingSenderId: "882211630737",
          appId: "1:882211630737:web:cb1c91a88b616cfe37d930",
          measurementId: "G-GRL90K1QCW",
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        // UI elements
        const daftarTabBtn = document.getElementById("daftar-tab");
        const adminTabBtn = document.getElementById("admin-tab");
        const btnLogout = document.getElementById("btnLogout");
        const btnOpenSettings = document.getElementById("btnOpenSettings");
        const btnToggleTheme = document.getElementById("btnToggleTheme");
        const overlayBlur = document.getElementById("overlayBlur");

        const judulDaftarProduk = document.getElementById("judulDaftarProduk");
        const judulAdmin = document.getElementById("judulAdmin");

        const tabelDaftarProduk = document.getElementById("tabelDaftarProduk");
        const tabelAdminProduk = document.getElementById("tabelAdminProduk");

        const btnTambah = document.getElementById("btnTambah");
        const formProduk = document.getElementById("formProduk");
        const inputNama = document.getElementById("inputNama");
        const inputHarga = document.getElementById("inputHarga");
        const inputBarcode = document.getElementById("inputBarcode");
        const btnBatal = document.getElementById("btnBatal");

        const modalLoginEl = document.getElementById("modalLogin");
        const modalLogin = new bootstrap.Modal(modalLoginEl, {
          keyboard: false,
        });
        const formLogin = document.getElementById("formLogin");
        const loginEmail = document.getElementById("loginEmail");
        const loginPassword = document.getElementById("loginPassword");
        const loginErrorDiv = document.getElementById("loginError");
        const btnCancelLogin = document.getElementById("btnCancelLogin");

        const btnScanBarcode = document.getElementById("btnScanBarcode");
        const btnStopScan = document.getElementById("btnStopScan");
        const readerElement = document.getElementById("reader");
        const scanResultElement = document.getElementById("scanResult");

        const adminSettings = document.getElementById("adminSettings");
        const formSettings = document.getElementById("formSettings");
        const settingTitle = document.getElementById("settingTitle");
        const settingLanguage = document.getElementById("settingLanguage");

        // Filter search input daftar produk
        const filterInput = document.getElementById("filter");

        filterInput.addEventListener("input", () => {
          const search = filterInput.value.toLowerCase().trim();
          const rows = tabelDaftarProduk.querySelectorAll("tr");

          rows.forEach((row) => {
            // Get product name text (assumed in first td)
            const productNameCell = row.querySelector("td:first-child");
            if (!productNameCell) return;

            const productName = productNameCell.textContent.toLowerCase();
            if (productName.includes(search)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });

        // Filter search input admin produk
        const filterAdminInput = document.getElementById("filterAdmin");

        filterAdminInput.addEventListener("input", () => {
          const search = filterAdminInput.value.toLowerCase().trim();
          const rows = tabelAdminProduk.querySelectorAll("tr");

          rows.forEach((row) => {
            // Get product name text (assumed in first td)
            const productNameCell = row.querySelector("td:first-child");
            if (!productNameCell) return;

            const productName = productNameCell.textContent.toLowerCase();
            if (productName.includes(search)) {
              row.style.display = "";
            } else {
              row.style.display = "none";
            }
          });
        });

        const settingsPanel = document.getElementById("settingsPanel"); // misal elemen container panel pengaturan

        btnOpenSettings.addEventListener("click", () => {
          // toggle tampilkan atau sembunyikan panel pengaturan
          const isOpen = settingsPanel.classList.contains("show");
          if (isOpen) {
            settingsPanel.classList.remove("show");
          } else {
            settingsPanel.classList.add("show");
          }
        });
        let modeEdit = false;
        let editId = null;
        let produkCache = [];
        let latestProduk = [];

        let html5QrcodeScanner = null;
        let scanning = false;

        const i18nData = {
          id: {
            product_name: "Nama Produk",
            price_rp: "Harga (Rp)",
            loading_data: "Sedang memuat data...",
            scan_barcode: "Scan Kode Batang",
            stop_scan: "Stop Scan",
            add_new_product: "Tambah Produk Baru",
            please_fill_product_name: "Mohon isi nama produk.",
            please_fill_valid_price: "Mohon isi harga produk yang valid.",
            barcode: "Kode Batang (Barcode)",
            barcode_help:
              "Kode batang ini digunakan untuk pencarian dengan scan.",
            save: "Simpan",
            cancel: "Batal",
            actions: "Aksi",
            email: "Email",
            please_enter_email: "Mohon masukkan email yang valid.",
            password: "Password",
            please_enter_password: "Mohon masukkan password.",
            login: "Login",
            loading_failed: "Tidak dapat memuat data.",
            found_product: "Produk ditemukan",
            product_not_found:
              'Produk dengan kode batang "{code}" tidak ditemukan di database.',
            logout_confirm: "Anda yakin ingin logout?",
            logout_success: "Logout berhasil",
            settings_title: "Judul Halaman Daftar Produk",
            settings_language: "Bahasa",
            settings_save: "Simpan Pengaturan",
            settings_label: "Pengaturan",
            toggle_theme: "Toggle Dark/Light Theme",
          },
          en: {
            product_name: "Product Name",
            price_rp: "Price (Rp)",
            loading_data: "Loading data...",
            scan_barcode: "Scan Barcode",
            stop_scan: "Stop Scan",
            add_new_product: "Add New Product",
            please_fill_product_name: "Please fill product name.",
            please_fill_valid_price: "Please enter a valid price.",
            barcode: "Barcode",
            barcode_help: "Barcode used for product lookup by scanning.",
            save: "Save",
            cancel: "Cancel",
            actions: "Actions",
            email: "Email",
            please_enter_email: "Please enter a valid email.",
            password: "Password",
            please_enter_password: "Please enter the password.",
            login: "Login",
            loading_failed: "Failed to load data.",
            found_product: "Product Found",
            product_not_found:
              'Product with barcode "{code}" not found in database.',
            logout_confirm: "Are you sure you want to logout?",
            logout_success: "Logout successful",
            settings_title: "Product List Page Title",
            settings_language: "Language",
            settings_save: "Save Settings",
            settings_label: "Settings",
            toggle_theme: "Toggle Dark/Light Theme",
          },
        };

        // Load language and theme from localStorage or defaults
        let currentLanguage = localStorage.getItem("ws_language") || "id";
        let currentTheme = localStorage.getItem("ws_theme") || "light";
        let customTitle = localStorage.getItem("ws_customTitle") || "";

        function translatePage(lang) {
          currentLanguage = lang;
          localStorage.setItem("ws_language", lang);
          document.querySelectorAll("[data-i18n]").forEach((el) => {
            const key = el.getAttribute("data-i18n");
            const text = i18nData[lang][key];
            if (text) {
              if (el.tagName === "INPUT" || el.tagName === "TEXTAREA") {
                el.placeholder = text;
              } else {
                el.textContent = text;
              }
            }
          });
          inputNama.placeholder =
            lang === "id" ? "Masukkan nama produk" : "Enter product name";
          inputHarga.placeholder =
            lang === "id" ? "Masukkan harga produk" : "Enter product price";
          inputBarcode.placeholder =
            lang === "id"
              ? "Masukkan kode batang atau scan"
              : "Enter barcode or scan";
          loginEmail.placeholder =
            lang === "id" ? "Masukkan email" : "Enter email";
          loginPassword.placeholder =
            lang === "id" ? "Masukkan password" : "Enter password";

          const modalLoginLabel = document.getElementById("modalLoginLabel");
          if (modalLoginLabel)
            modalLoginLabel.textContent =
              lang === "id" ? "Login Admin" : "Admin Login";

          btnTambah.textContent =
            lang === "id" ? "Tambah Produk Baru" : "Add New Product";
          btnScanBarcode.textContent =
            lang === "id" ? "Scan Kode Batang" : "Scan Barcode";
          btnStopScan.textContent = lang === "id" ? "Stop Scan" : "Stop Scan";

          // Settings panel labels
          const settingLabels =
            adminSettings.querySelectorAll("label, h3, button");
          settingLabels.forEach((lbl) => {
            if (lbl.tagName === "H3") {
              lbl.textContent = lang === "id" ? "Pengaturan" : "Settings";
            } else if (lbl.tagName === "LABEL") {
              if (lbl.htmlFor === "settingTitle") {
                lbl.textContent =
                  lang === "id"
                    ? "Judul Halaman Daftar Produk"
                    : "Product List Page Title";
              } else if (lbl.htmlFor === "settingLanguage") {
                lbl.textContent = lang === "id" ? "Bahasa" : "Language";
              }
            } else if (lbl.tagName === "BUTTON") {
              lbl.textContent =
                lang === "id" ? "Simpan Pengaturan" : "Save Settings";
            }
          });

          // Table headers
          document
            .querySelectorAll(
              "#tabelDaftarProduk thead th, #tabelAdminProduk thead th"
            )
            .forEach((th) => {
              const key = th.getAttribute("data-i18n");
              if (key && i18nData[lang][key]) {
                th.textContent = i18nData[lang][key];
              }
            });

          if (tabelDaftarProduk.children.length === 0) {
            tabelDaftarProduk.innerHTML = `<tr><td colspan="2" class="text-center fst-italic">${i18nData[lang].loading_data}</td></tr>`;
          }
          if (tabelAdminProduk.children.length === 0) {
            tabelAdminProduk.innerHTML = `<tr><td colspan="3" class="text-center fst-italic">${i18nData[lang].loading_data}</td></tr>`;
          }
        }
        function applyTheme(theme) {
          currentTheme = theme;
          if (theme === "dark") {
            document.body.classList.add("dark-theme");
          } else {
            document.body.classList.remove("dark-theme");
          }
          localStorage.setItem("ws_theme", theme);
          btnToggleTheme.setAttribute(
            "aria-label",
            i18nData[currentLanguage].toggle_theme || "Toggle Dark/Light Theme"
          );
          btnToggleTheme.title = btnToggleTheme.getAttribute("aria-label");
        }
        function updateTitle(newTitle) {
          if (newTitle.trim() === "") {
            customTitle = "";
          } else {
            customTitle = newTitle.trim();
          }
          localStorage.setItem("ws_customTitle", customTitle);
          renderTitle();
        }
        function renderTitle() {
          if (customTitle) {
            judulDaftarProduk.textContent = customTitle;
          } else {
            judulDaftarProduk.textContent =
              currentLanguage === "id"
                ? "Daftar Harga Warung Sembako"
                : "Product Price List";
          }
        }

        // ======================== Firestore per-user Produk ===============
        let unsubscribeProdukUser = null;

        // Mulai listening produk user saat login
        function mulaiSnapshotListenerProdukUser() {
          if (unsubscribeProdukUser) {
            unsubscribeProdukUser();
            unsubscribeProdukUser = null;
          }

          const user = auth.currentUser;
          if (!user) {
            renderDaftarProduk([]);
            renderAdminProduk([]);
            return;
          }
          const produkUserRef = db
            .collection("produk")
            .doc(user.uid)
            .collection("produkUser")
            .orderBy("nama");

          unsubscribeProdukUser = produkUserRef.onSnapshot(
            (snapshot) => {
              const items = [];
              snapshot.forEach((doc) =>
                items.push({ id: doc.id, ...doc.data() })
              );
              produkCache = items;
              latestProduk = produkCache;
              renderDaftarProduk(items);
              renderAdminProduk(items);
            },
            (error) => {
              Swal.fire(
                i18nData[currentLanguage].loading_failed,
                error.message,
                "error"
              );
              renderDaftarProduk([]);
              renderAdminProduk([]);
              unsubscribeProdukUser = null;
            }
          );
        }

        // Merender daftar produk user di tampilan publik (tab daftar)
        function renderDaftarProduk(items) {
          if (!items.length) {
            tabelDaftarProduk.innerHTML = `<tr><td colspan="2" class="text-center fst-italic">${i18nData[currentLanguage].loading_data}</td></tr>`;
            return;
          }
          tabelDaftarProduk.innerHTML = items
            .map(
              (p) =>
                `<tr>
                  <td>${escapeHTML(p.nama)} ${
                  p.barcode
                    ? `<small class="text-muted">[${escapeHTML(
                        p.barcode
                      )}]</small>`
                    : ""
                }</td>
                  <td>Rp ${p.harga.toLocaleString("id-ID")}</td>
                </tr>`
            )
            .join("");
        }

        // Merender tabel admin produk user dengan edit dan hapus
        function renderAdminProduk(items) {
          if (!items.length) {
            tabelAdminProduk.innerHTML = `<tr><td colspan="3" class="text-center fst-italic">${i18nData[currentLanguage].loading_data}</td></tr>`;
            return;
          }
          tabelAdminProduk.innerHTML = items
            .map(
              (p) =>
                `<tr data-id="${p.id}">
                  <td>${escapeHTML(p.nama)}</td>
                  <td>Rp ${p.harga.toLocaleString("id-ID")}</td>
                  <td>
                    <button class="btn btn-warning btn-sm me-2 btn-edit" aria-label="Edit produk ${escapeHTML(
                      p.nama
                    )}">Edit</button>
                    <button class="btn btn-danger btn-sm btn-delete" aria-label="Hapus produk ${escapeHTML(
                      p.nama
                    )}">Hapus</button>
                  </td>
                </tr>`
            )
            .join("");

          tabelAdminProduk.querySelectorAll(".btn-edit").forEach((btn) => {
            btn.onclick = () => {
              const tr = btn.closest("tr");
              editId = tr.getAttribute("data-id");
              const produk = produkCache.find((p) => p.id === editId);
              if (!produk) return;
              inputNama.value = produk.nama;
              inputHarga.value = produk.harga;
              inputBarcode.value = produk.barcode || "";
              openForm(true);
            };
          });
          tabelAdminProduk.querySelectorAll(".btn-delete").forEach((btn) => {
            btn.onclick = () => {
              const tr = btn.closest("tr");
              const id = tr.getAttribute("data-id");
              Swal.fire({
                title:
                  currentLanguage === "id"
                    ? "Yakin ingin menghapus produk ini?"
                    : "Are you sure to delete this product?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonColor: "#d33",
                cancelButtonColor: "#3085d6",
                confirmButtonText:
                  currentLanguage === "id" ? "Ya, hapus!" : "Yes, delete!",
                cancelButtonText: currentLanguage === "id" ? "Batal" : "Cancel",
              }).then((result) => {
                if (result.isConfirmed) {
                  const user = auth.currentUser;
                  if (!user) return;
                  db.collection("produk")
                    .doc(user.uid)
                    .collection("produkUser")
                    .doc(id)
                    .delete()
                    .then(() => {
                      Swal.fire(
                        currentLanguage === "id" ? "Terhapus!" : "Deleted!",
                        currentLanguage === "id"
                          ? "Produk berhasil dihapus."
                          : "Product successfully deleted.",
                        "success"
                      );
                    })
                    .catch((err) => {
                      Swal.fire("Error", err.message, "error");
                    });
                }
              });
            };
          });
        }

        // Membuka form (tambah/edit)
        function openForm(edit = false) {
          modeEdit = edit;
          formProduk.classList.remove("d-none");
          btnTambah.disabled = true;
          inputNama.focus();
        }
        // Menutup form dan reset
        function closeForm() {
          formProduk.classList.add("d-none");
          btnTambah.disabled = false;
          modeEdit = false;
          editId = null;
          formProduk.reset();
          formProduk.classList.remove("was-validated");
        }

        btnTambah.onclick = () => openForm(false);
        btnBatal.onclick = () => closeForm();

        formProduk.addEventListener("submit", async (e) => {
          e.preventDefault();
          e.stopPropagation();
          formProduk.classList.add("was-validated");
          if (!formProduk.checkValidity()) return;

          const nama = inputNama.value.trim();
          const harga = Number(inputHarga.value);
          const barcode = inputBarcode.value.trim();

          if (nama === "" || isNaN(harga) || harga < 0) {
            Swal.fire(
              "Error",
              currentLanguage === "id"
                ? "Isi nama dan harga produk dengan benar."
                : "Please fill in the product name and price correctly.",
              "error"
            );
            return;
          }

          const user = auth.currentUser;
          if (!user) {
            Swal.fire(
              "Error",
              currentLanguage === "id"
                ? "Anda harus login."
                : "You must login.",
              "error"
            );
            closeForm();
            return;
          }

          try {
            const produkRef = db
              .collection("produk")
              .doc(user.uid)
              .collection("produkUser");

            if (modeEdit && editId) {
              await produkRef
                .doc(editId)
                .update({ nama, harga, barcode: barcode || null });
              Swal.fire(
                currentLanguage === "id" ? "Berhasil" : "Success",
                currentLanguage === "id"
                  ? "Produk berhasil diperbarui."
                  : "Product successfully updated.",
                "success"
              );
            } else {
              await produkRef.add({ nama, harga, barcode: barcode || null });
              Swal.fire(
                currentLanguage === "id" ? "Berhasil" : "Success",
                currentLanguage === "id"
                  ? "Produk berhasil ditambahkan."
                  : "Product successfully added.",
                "success"
              );
            }
            closeForm();
          } catch (err) {
            Swal.fire("Error", err.message, "error");
          }
        });

        // Tab management
        const daftarTab = new bootstrap.Tab(daftarTabBtn);
        const adminTab = new bootstrap.Tab(adminTabBtn);

        adminTabBtn.addEventListener("click", (e) => {
          if (!auth.currentUser) {
            e.preventDefault();
            modalLogin.show();
            aktifkanBlur();
          }
        });

        formLogin.addEventListener("submit", (e) => {
          e.preventDefault();
          e.stopPropagation();
          formLogin.classList.add("was-validated");
          loginErrorDiv.textContent = "";

          if (!formLogin.checkValidity()) return;

          auth
            .signInWithEmailAndPassword(
              loginEmail.value.trim(),
              loginPassword.value
            )
            .then(() => {
              modalLogin.hide();
              formLogin.reset();
              formLogin.classList.remove("was-validated");
              Swal.fire(
                currentLanguage === "id"
                  ? "Login berhasil"
                  : "Login successful",
                "",
                "success"
              );
              adminTab.show();
              mulaiSnapshotListenerProdukUser();
            })
            .catch((err) => {
              loginErrorDiv.textContent = err.message;
            });
        });

        btnCancelLogin.addEventListener("click", () => {
          modalLogin.hide();
          daftarTab.show();
        });

        modalLoginEl.addEventListener("hidden.bs.modal", () => {
          matikanBlur();
        });

        btnLogout.onclick = () => {
          Swal.fire({
            title: i18nData[currentLanguage].logout_confirm,
            icon: "warning",
            showCancelButton: true,
            confirmButtonText:
              currentLanguage === "id" ? "Ya, Logout" : "Yes, Logout",
            cancelButtonText: currentLanguage === "id" ? "Batal" : "Cancel",
            confirmButtonColor: "#d33",
            cancelButtonColor: "#3085d6",
          }).then((result) => {
            if (result.isConfirmed) {
              auth.signOut();
              Swal.fire(
                i18nData[currentLanguage].logout_success,
                "",
                "success"
              );
            }
          });
        };

        auth.onAuthStateChanged((user) => {
          if (user) {
            matikanBlur();
            btnLogout.classList.remove("d-none");
            btnTambah.disabled = false;
            btnOpenSettings.classList.remove("d-none");
            mulaiSnapshotListenerProdukUser();

            let namaUser = "Admin";
            if (user.displayName && user.displayName.trim()) {
              namaUser = user.displayName;
            } else if (user.email) {
              namaUser = user.email.split("@")[0];
            }
            judulAdmin.textContent = `Hello ${namaUser}!`;
            adminSettings.classList.remove("d-none");
          } else {
            btnLogout.classList.add("d-none");
            btnTambah.disabled = true;
            btnOpenSettings.classList.add("d-none");
            adminSettings.classList.add("d-none");
            closeForm();
            if (unsubscribeProdukUser) {
              unsubscribeProdukUser();
              unsubscribeProdukUser = null;
            }
            tabelDaftarProduk.innerHTML = `<tr><td colspan="2" class="text-center fst-italic">${i18nData[currentLanguage].loading_data}</td></tr>`;
            tabelAdminProduk.innerHTML = `<tr><td colspan="3" class="text-center fst-italic">${i18nData[currentLanguage].loading_data}</td></tr>`;

            judulAdmin.textContent = "Hello {User}";

            if (document.querySelector(".nav-link.active").id === "admin-tab") {
              daftarTab.show();
            }
          }
          renderTitle();
        });

        // Barcode scanner
        if (window.Html5Qrcode) {
          html5QrcodeScanner = new Html5Qrcode("reader");
        } else {
          console.warn("Library html5-qrcode belum dimuat.");
        }

        function cariProdukByBarcode(code) {
          if (!code) return null;
          code = code.trim();
          if (!Array.isArray(latestProduk)) return null;
          return latestProduk.find((p) => p.barcode && p.barcode === code);
        }
        function playBeep() {
          try {
            const ctx = new (window.AudioContext ||
              window.webkitAudioContext)();
            const oscillator = ctx.createOscillator();
            const gainNode = ctx.createGain();

            oscillator.type = "square";
            oscillator.frequency.value = 880; // Hz beep
            gainNode.gain.value = 0.2; // volume

            oscillator.connect(gainNode);
            gainNode.connect(ctx.destination);

            oscillator.start();
            setTimeout(() => {
              oscillator.stop();
              ctx.close();
            }, 150);
          } catch {
            // fallback no sound
          }
        }
        function tampilkanHasilScan(code) {
          playBeep();
          const produk = cariProdukByBarcode(code);
          if (produk) {
            scanResultElement.textContent = `${
              i18nData[currentLanguage].found_product
            }: ${produk.nama} ‚Äî Rp ${produk.harga.toLocaleString("id-ID")}`;
            Swal.fire({
              icon: "success",
              title: i18nData[currentLanguage].found_product,
              html: `<b>${produk.nama}</b><br/>Rp ${produk.harga.toLocaleString(
                "id-ID"
              )}`,
              timer: 3000,
              showConfirmButton: false,
            });
          } else {
            scanResultElement.textContent = `${i18nData[
              currentLanguage
            ].product_not_found.replace("{code}", code)}`;
            Swal.fire({
              icon: "error",
              title: i18nData[currentLanguage].product_not_found.replace(
                "{code}",
                code
              ),
              timer: 3000,
              showConfirmButton: false,
            });
          }
        }

        btnScanBarcode.onclick = () => {
          if (scanning) return;
          scanning = true;
          btnScanBarcode.classList.add("d-none");
          btnStopScan.classList.remove("d-none");
          readerElement.style.display = "block";
          scanResultElement.textContent = "";
          if (html5QrcodeScanner) {
            html5QrcodeScanner
              .start(
                { facingMode: "environment" },
                {
                  fps: 10,
                  qrbox: { width: 300, height: 100 },
                  formatsToSupport: [
                    Html5QrcodeSupportedFormats.CODE_128,
                    Html5QrcodeSupportedFormats.EAN_13,
                    Html5QrcodeSupportedFormats.EAN_8,
                    Html5QrcodeSupportedFormats.UPC_A,
                    Html5QrcodeSupportedFormats.UPC_E,
                    Html5QrcodeSupportedFormats.CODE_39,
                    Html5QrcodeSupportedFormats.QR_CODE,
                  ],
                },
                (decodedText) => {
                  tampilkanHasilScan(decodedText);
                  html5QrcodeScanner.stop();
                  scanning = false;
                  btnScanBarcode.classList.remove("d-none");
                  btnStopScan.classList.add("d-none");
                  readerElement.style.display = "none";
                },
                (errorMessage) => {}
              )
              .catch((err) => {
                Swal.fire(
                  i18nData[currentLanguage].loading_failed,
                  "Tidak dapat mengakses kamera: " + err.message,
                  "error"
                );
                scanning = false;
                btnScanBarcode.classList.remove("d-none");
                btnStopScan.classList.add("d-none");
                readerElement.style.display = "none";
              });
          }
        };
        btnStopScan.onclick = () => {
          if (!scanning) return;
          html5QrcodeScanner
            .stop()
            .then(() => {
              scanning = false;
              btnScanBarcode.classList.remove("d-none");
              btnStopScan.classList.add("d-none");
              readerElement.style.display = "none";
              scanResultElement.textContent = "";
            })
            .catch(console.error);
        };

        // Blur functions
        function aktifkanBlur() {
          overlayBlur.classList.add("active");
        }
        function matikanBlur() {
          overlayBlur.classList.remove("active");
        }

        // Settings toggle
        btnOpenSettings.addEventListener("click", () => {
          if (!adminSettings.classList.contains("d-none")) {
            adminSettings.classList.add("d-none");
          } else {
            settingTitle.value = customTitle;
            settingLanguage.value = currentLanguage;
            adminSettings.classList.remove("d-none");
          }
        });

        formSettings.addEventListener("submit", (e) => {
          e.preventDefault();
          updateTitle(settingTitle.value);
          translatePage(settingLanguage.value);
          Swal.fire(
            currentLanguage === "id" ? "Berhasil" : "Success",
            currentLanguage === "id"
              ? "Pengaturan berhasil disimpan."
              : "Settings successfully saved.",
            "success"
          );
          adminSettings.classList.add("d-none");
        });

        btnToggleTheme.addEventListener("click", () => {
          const newTheme = currentTheme === "dark" ? "light" : "dark";
          applyTheme(newTheme);
        });

        // Accessibility helper: escape HTML to prevent injection
        function escapeHTML(str) {
          return str.replace(/[&<>"']/g, (m) => {
            switch (m) {
              case "&":
                return "&amp;";
              case "<":
                return "&lt;";
              case ">":
                return "&gt;";
              case '"':
                return "&quot;";
              case "'":
                return "&#039;";
              default:
                return m;
            }
          });
        }

        // Initialize page
        translatePage(currentLanguage);
        applyTheme(currentTheme);
        renderTitle();
      })();
    </script>
  </body>
</html>
